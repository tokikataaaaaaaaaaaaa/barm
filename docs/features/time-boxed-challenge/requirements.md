# Feature Requirements: Time-Boxed Challenge

**Feature Name:** `time-boxed-challenge`
**Service:** `barm`
**Phase:** 2 - Requirements
**Created:** 2026-01-03
**Updated:** 2026-01-04
**Status:** Demo Reviewed - Ready for Implementation

---

## 0. デザイン原則

以下はデモレビューで確定したUX設計の基本原則：

1. **自己中心的な表示**: 自分の記録を常に一番上に表示し、カレンダーの色は自分の達成状況のみで決定する
2. **シンプルな達成表示**: パーセンテージではなく「X/Y日達成」形式を使用（より直感的で意味がある）
3. **優越感によるモチベーション**: 他人ができていなくても自分ができていれば緑色表示、自己肯定感を高める設計
4. **適切なチームサイズ**: 5〜9人の小規模チームで「仲間感」を維持

---

## 1. ユーザーストーリー

### US-001: チャレンジ一覧を見る

**ストーリー:**
> ユーザーとして、現在参加可能なチャレンジ一覧を見たい。どのチャレンジに参加するか選ぶため。

**受け入れ基準:**
- [ ] トップページにチャレンジ一覧が表示される
- [ ] 各チャレンジに期間（1週間/2週間/1ヶ月）が表示される
- [ ] 各チャレンジに現在の参加者数が表示される
- [ ] 各チャレンジに参加者のアバター（最大5人）が表示される
- [ ] 開始日・終了日が表示される

**優先度:** P0 (Must-have)
**工数:** 0.5日

---

### US-002: チャレンジに参加する

**ストーリー:**
> ユーザーとして、チャレンジに参加したい。期限付きの目標を設定して仲間と一緒に頑張るため。

**受け入れ基準:**
- [ ] 「参加する」ボタンをタップできる
- [ ] 参加時に自分の目標を設定できる（例: 腕立て50回/日）
- [ ] 目標名・目標値・単位を入力できる
- [ ] 初回チャレンジは無料で参加できる
- [ ] 2回目以降は料金が表示される（実際の課金はチャレンジ終了後）
- [ ] 参加後、チャレンジ詳細画面に遷移する

**優先度:** P0 (Must-have)
**工数:** 1日

---

### US-002.5: チャレンジ待機・目標編集

**ストーリー:**
> ユーザーとして、チャレンジ開始前に目標を編集したい。参加後でも気が変わることがあるため。

**受け入れ基準:**
- [ ] チャレンジ開始前は待機画面が表示される
- [ ] 待機画面で開始までのカウントダウンが見える
- [ ] 待機画面で参加者一覧が見える（チーム分け前は全員表示）
- [ ] 開始前は目標を編集できる
- [ ] 開始後は目標を編集できない（確定される）

**優先度:** P1 (Should-have)
**工数:** 0.5日

---

### US-003: チャレンジ参加者を見る（カレンダービュー）

**ストーリー:**
> ユーザーとして、カレンダー形式でみんなの記録を見たい。日ごとの達成状況を把握するため。

**受け入れ基準:**
- [ ] 自分の記録が一番上に常時表示される（タップ不要）
- [ ] 自分の1週間分のカレンダーが常に見える
- [ ] カレンダーの色は自分の達成状況のみで決まる（他人の状況は関係なし）
- [ ] 日付をタップすると他の参加者の記録が見える
- [ ] 各参加者の任意メモが確認できる

**優先度:** P0 (Must-have)
**工数:** 1日

---

### US-004: 日々の記録をつける

**ストーリー:**
> ユーザーとして、毎日の達成を記録したい。チャレンジの進捗を可視化するため。

**受け入れ基準:**
- [ ] チャレンジ詳細画面から記録を入力できる
- [ ] +/- ボタンで値を増減できる
- [ ] 目標達成時に視覚的なフィードバックがある（色の変化、アニメーション）
- [ ] 記録は日付ごとに保存される
- [ ] カレンダー形式で過去の記録を確認できる

**優先度:** P0 (Must-have)
**工数:** 0.5日（既存機能を流用）

---

### US-005: チャレンジの進捗を確認する

**ストーリー:**
> ユーザーとして、チャレンジ全体の進捗を確認したい。あと何日で完走できるか把握するため。

**受け入れ基準:**
- [ ] 残り日数が表示される
- [ ] 自分の達成日数/全体日数が「X/Y日達成」形式で表示される
- [ ] パーセンテージ表記は使用しない（意味がないため）
- [ ] シンプルなプログレスバーで視覚化される

**優先度:** P1 (Should-have)
**工数:** 0.5日

---

### US-006: チャレンジを完走する

**ストーリー:**
> ユーザーとして、チャレンジを完走したら祝福されたい。達成感を味わうため。

**受け入れ基準:**
- [ ] チャレンジ終了日に完走判定が行われる
- [ ] 結果は「X/Y日達成」形式で表示される（パーセンテージ不使用）
- [ ] 達成日数に応じた結果が表示される（完走/惜しい/ドンマイ）
- [ ] 完走時はお祝いアニメーション（紙吹雪）が表示される
- [ ] 仲間の結果がランキング形式で表示される
- [ ] 次のチャレンジへの誘導が表示される

**優先度:** P1 (Should-have)
**工数:** 1日

---

### US-007: 次のチャレンジに課金して参加する

**ストーリー:**
> ユーザーとして、チャレンジ完走後に次のチャレンジに課金して参加したい。継続してモチベーションを維持するため。

**受け入れ基準:**
- [ ] チャレンジ終了後、次のチャレンジ選択画面が表示される
- [ ] 各期間の料金が表示される（1週間100円/2週間200円/1ヶ月300円）
- [ ] App Store 決済で支払いできる
- [ ] 支払い完了後、新しいチャレンジに参加できる
- [ ] 支払い履歴は RevenueCat で管理される

**優先度:** P0 (Must-have)
**工数:** 1.5日

---

## 2. 機能要件

### 2.1 データモデル

```typescript
// Challenge（チャレンジ）
interface Challenge {
  id: string
  type: '1week' | '2week' | '1month'
  startDate: Date        // チャレンジ開始日
  endDate: Date          // チャレンジ終了日
  status: 'upcoming' | 'active' | 'completed'
  participantCount: number
  createdAt: Date
}

// ChallengeParticipation（チャレンジ参加）
interface ChallengeParticipation {
  id: string
  challengeId: string
  userId: string
  teamId: string         // チーム分けされた場合のチームID
  goal: {
    name: string         // 例: 腕立て伏せ
    targetValue: number  // 例: 50
    unit: string         // 例: 回
  }
  isPaid: boolean        // 課金済みか
  achievedDays: number   // 達成した日数
  joinedAt: Date
}

// ChallengeRecord（チャレンジ記録）
interface ChallengeRecord {
  id: string
  participationId: string
  date: string           // YYYY-MM-DD
  value: number          // 達成値
  achieved: boolean      // 目標達成したか
  memo?: string          // 任意のメモ
  createdAt: Date
}
```

### 2.2 Firestore 構造

```
challenges/
  {challengeId}/
    type: string
    startDate: timestamp
    endDate: timestamp
    status: string
    participantCount: number
    createdAt: timestamp

challengeTeams/
  {teamId}/
    challengeId: string
    memberIds: string[]      # 5〜9人のチームメンバー
    createdAt: timestamp

challengeParticipations/
  {participationId}/
    challengeId: string
    userId: string
    teamId: string           # チーム分け後に設定
    goal: { name, targetValue, unit }
    isPaid: boolean
    achievedDays: number     # 達成日数
    joinedAt: timestamp

challengeRecords/
  {recordId}/
    participationId: string
    date: string
    value: number
    achieved: boolean        # 目標達成したか
    memo: string             # 任意メモ（optional）
    createdAt: timestamp
```

### 2.3 ビジネスルール

| ルール | 詳細 |
|--------|------|
| チャレンジ期間 | 1週間（7日）/ 2週間（14日）/ 1ヶ月（30日） |
| チーム人数 | 最小5人〜最大9人（開始時に自動分配） |
| チーム分け | 参加者を5〜9人のチームに均等分配 |
| 初回無料 | 初めてのチャレンジ参加は無料 |
| 課金タイミング | チャレンジ完走後、次回参加時に課金 |
| 価格 | 1週間: 100円 / 2週間: 200円 / 1ヶ月: 300円 |
| 完走条件 | チャレンジ期間を終了まで参加し続けること |
| 達成表示 | 「X/Y日達成」形式（パーセンテージ不使用） |
| 完走判定 | 80%以上: 完走 / 50%以上: 惜しい / 50%未満: ドンマイ |
| 目標編集 | チャレンジ開始前のみ可能 |

### 2.4 画面一覧

| 画面ID | 画面名 | 主要機能 |
|--------|--------|----------|
| C-001 | チャレンジ一覧 | 参加可能なチャレンジを表示 |
| C-002 | チャレンジ参加 | 目標設定・参加確認 |
| C-002.5 | チャレンジ待機 | 開始前待機・目標編集・参加者一覧 |
| C-003 | チャレンジ詳細 | カレンダービュー・進捗・記録入力 |
| C-004 | チャレンジ結果 | 完走結果・仲間ランキング・次回誘導 |
| C-005 | 課金確認 | 次回チャレンジの課金処理 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 項目 | 目標 |
|------|------|
| チャレンジ一覧読み込み | 1秒以内 |
| 参加者一覧読み込み | 2秒以内（100人まで） |
| 記録保存 | 0.5秒以内 |

### 3.2 セキュリティ

| 項目 | 要件 |
|------|------|
| データアクセス | 自分の記録のみ編集可能 |
| 他参加者の記録 | 閲覧のみ可能（編集不可） |
| 課金情報 | RevenueCat 経由、アプリ内保存なし |

### 3.3 アクセシビリティ

| 項目 | 要件 |
|------|------|
| VoiceOver | 基本対応 |
| コントラスト比 | WCAG 2.1 AA 準拠 |
| タップターゲット | 最小 44x44 px |

---

## 4. スコープ定義

### In Scope（今回実装）

- チャレンジ一覧表示
- チャレンジ参加（目標設定）
- 参加者一覧表示
- 日々の記録入力
- チャレンジ完走判定
- 次回チャレンジへの課金

### Out of Scope（今回は除外）

| 機能 | 理由 |
|------|------|
| チャット機能 | 複雑さ増大、差別化ポイントでもある |
| ランキング | Phase 2 以降で検討 |
| バッジ・称号 | ゲーミフィケーションは後回し |
| プッシュ通知 | 別途 FCM 連携が必要 |
| チャレンジ作成（管理者） | 初期はハードコード or Firestore Console |

### 将来の拡張

- カスタムチャレンジ作成（ユーザー主導）
- チーム対抗戦
- 週間/月間ランキング
- 完走バッジコレクション

---

## 5. 技術的制約

### 既存スタックとの整合性

| 項目 | 対応 |
|------|------|
| Next.js 14 | App Router 使用、新規ページ追加 |
| Firebase (Web SDK) | 既存の設定を流用 |
| React Query | チャレンジ用の新規フック追加 |
| RevenueCat | 既存の Flutter Bridge 経由で課金 |
| TailwindCSS | 既存のデザインシステムを活用 |

### 依存関係

- 既存の認証機能（Firebase Auth）
- 既存の課金機能（RevenueCat via Flutter Bridge）
- 既存の UI コンポーネント（Button, Card, Avatar, etc.）

---

## 6. 次のステップ

### Phase 3: UX Design

```
/feature-phase3-ux-design barm time-boxed-challenge
```

以下を作成:
- ワイヤーフレーム
- UI デザイン（frontend-design skill 使用）
- インタラクション仕様
